---
- name: Setup Hadoop Cluster Nodes
  hosts: all
  become: yes
  vars:
    hadoop_version: "3.4.0"
    hadoop_user: "hdoop"
    download_dir: "/home/{{ hadoop_user }}/Downloads"
    hadoop_home: "/home/{{ hadoop_user }}/hadoop-{{ hadoop_version }}"

  tasks:
    - name: Stop firewalld service
      service:
        name: firewalld
        state: stopped
        enabled: no
      ignore_errors: yes

- name: Configure NameNode
  hosts: namenode
  become: yes
  vars_prompt:
    - name: namenode_dir
      private: no
      prompt: "Enter location directory path for Name Node"
  tasks:
    - name: Create NameNode Directory
      file:
        path: "{{ namenode_dir }}"
        state: directory
        owner: "{{ hadoop_user }}"
        group: "{{ hadoop_user }}"
        mode: '0750'

    - name: Configure hdfs-site.xml for NameNode
      blockinfile:
        path: "{{ hadoop_home }}/etc/hadoop/hdfs-site.xml"
        insertafter: "<configuration>"
        block: |
          <property>
              <name>dfs.namenode.name.dir</name>
              <value>{{ namenode_dir }}</value>
          </property>
          <property>
              <name>dfs.replication</name>
              <value>3</value>
          </property>

    - name: Configure core-site.xml for NameNode
      blockinfile:
        path: "{{ hadoop_home }}/etc/hadoop/core-site.xml"
        insertafter: "<configuration>"
        block: |
          <property>
              <name>fs.defaultFS</name>
              <value>hdfs://{{ groups['namenode'][0] }}:9000</value>
          </property>

    - name: Format NameNode
      become_user: "{{ hadoop_user }}"
      command: "{{ hadoop_home }}/bin/hdfs namenode -format -force"
      ignore_errors: yes

    - name: Start NameNode daemon
      become_user: "{{ hadoop_user }}"
      command: "{{ hadoop_home }}/bin/hdfs --daemon start namenode"
      ignore_errors: yes

- name: Configure DataNode
  hosts: datanode
  become: yes
  vars_prompt:
    - name: datanode_dir
      private: no
      prompt: "Enter location directory path for Data Node"
  tasks:
    - name: Create DataNode Directory
      file:
        path: "{{ datanode_dir }}"
        state: directory
        owner: "{{ hadoop_user }}"
        group: "{{ hadoop_user }}"
        mode: '0750'

    - name: Configure hdfs-site.xml for DataNode
      blockinfile:
        path: "{{ hadoop_home }}/etc/hadoop/hdfs-site.xml"
        insertafter: "<configuration>"
        block: |
          <property>
              <name>dfs.datanode.data.dir</name>
              <value>{{ datanode_dir }}</value>
          </property>

    - name: Configure core-site.xml for DataNode
      blockinfile:
        path: "{{ hadoop_home }}/etc/hadoop/core-site.xml"
        insertafter: "<configuration>"
        block: |
          <property>
              <name>fs.defaultFS</name>
              <value>hdfs://{{ groups['namenode'][0] }}:9000</value>
          </property>

    - name: Start DataNode daemon
      become_user: "{{ hadoop_user }}"
      command: "{{ hadoop_home }}/bin/hdfs --daemon start datanode"
      ignore_errors: yes
