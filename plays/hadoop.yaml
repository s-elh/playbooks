---
- name: Configure Kubernetes access
  hosts: all
  become: true
  tasks:
    - name: Configure resolv.conf with Google DNS
      shell: echo nameserver 8.8.8.8 > /etc/resolv.conf
    
    - name: Clear apt proxy settings
      shell: echo > /etc/apt/apt.conf.d/90curtin-aptproxy

    - name: Create .kube directory
      file:
        path: /root/.kube
        state: directory
        mode: '0755'

    - name: Copy admin.conf to root's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        owner: root
        group: root
        mode: '0600'
      ignore_errors: yes

    - name: Restart kubelet service
      systemd:
        name: kubelet
        state: restarted
        daemon_reload: yes

    - name: Test kubectl connection
      command: kubectl get nodes
      register: kubectl_test
      ignore_errors: yes

    - name: Display kubectl test result
      debug:
        var: kubectl_test.stdout_lines
